<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stethoscope AI - Instant Server Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .hero-bg {
            background-image: radial-gradient(#1f2937 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .btn-primary {
            background-color: #0ea5e9;
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #0284c7; }
        .report-content h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; }
        .report-content p { margin-top: 0.5rem; line-height: 1.6; }
        .report-content code { background-color: #374151; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: 'Courier New', Courier, monospace; }
        .report-content pre { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; overflow-x: auto; }
        .issue-card { background-color: #1f2937; border: 1px solid #374151; border-left-width: 4px; padding: 1.5rem; margin-top: 1.5rem; border-radius: 0.5rem; }
        .issue-card.critical { border-left-color: #f87171; }
        .issue-card.warning { border-left-color: #facc15; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <!-- HERO SECTION -->
        <section class="py-20 md:py-32 hero-bg">
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-6xl font-black text-white leading-tight">Instant, AI-Powered Diagnostics <br> for Your <span class="text-sky-400">Linux Server</span>.</h1>
                <p class="mt-6 text-lg md:text-xl max-w-3xl mx-auto">Go from "Server Down" to "Root Cause Found" in under 60 seconds. Stethoscope AI is your on-demand expert consultant for complex server issues.</p>
                <a href="#analyzer-tool" class="mt-10 inline-block btn-primary font-bold py-4 px-8 rounded-lg text-lg">Start Analysis Now</a>
            </div>
        </section>

        <!-- THE TOOL SECTION -->
        <section id="analyzer-tool" class="py-20">
            <div class="container mx-auto px-6 max-w-4xl">
                <h2 class="text-3xl font-bold text-center text-white">Generate Your Health Report</h2>
                <div class="mt-12">
                    <div class="mb-12">
                        <h3 class="text-xl font-semibold text-white mb-2">Step 1: Copy this command</h3>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                            <pre><code class="text-gray-300">curl -sSL https://your-netlify-site.netlify.app/analyzer.sh | bash</code></pre>
                            <button onclick="copyCommand()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Copy</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-2">Step 2: Paste the output from your terminal below</h3>
                        <textarea id="snapshot-input" rows="8" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-gray-300 focus:ring-2 focus:ring-sky-500 focus:outline-none" placeholder="Paste your encoded snapshot output here..."></textarea>
                        <button onclick="analyzeServer()" id="analyze-button" class="mt-4 w-full btn-primary font-bold py-4 px-8 rounded-lg text-lg">Analyze My Server</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- RESULTS WRAPPER (Initially Hidden) -->
        <div id="results-wrapper" class="hidden">
            <!-- INSTANT METRICS SECTION -->
            <section id="metrics-section" class="py-20 bg-gray-900">
                 <div class="container mx-auto px-6 max-w-6xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-12">Instant Metrics Snapshot</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <!-- CPU Card -->
                        <div class="bg-gray-800 p-6 rounded-lg flex flex-col items-center">
                            <h3 class="text-xl font-bold text-white mb-4">CPU Utilization</h3>
                            <div class="w-48 h-48 relative"><canvas id="cpuChart"></canvas></div>
                        </div>
                        <!-- Memory Card -->
                        <div class="bg-gray-800 p-6 rounded-lg flex flex-col items-center">
                            <h3 class="text-xl font-bold text-white mb-4">Memory Usage</h3>
                            <div class="w-48 h-48 relative"><canvas id="memChart"></canvas></div>
                        </div>
                        <!-- Disk Card -->
                        <div class="bg-gray-800 p-6 rounded-lg">
                             <h3 class="text-xl font-bold text-white text-center mb-4">Disk Usage</h3>
                             <div id="disk-charts-container" class="space-y-4"></div>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- AI REPORT SECTION -->
            <section id="report-section" class="py-20">
                 <div class="container mx-auto px-6 max-w-4xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-8">Your AI-Generated Analysis</h2>
                    <div id="report-output" class="bg-gray-800 border border-gray-700 rounded-lg">
                        <div id="loading-indicator" class="text-center p-8">
                            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p class="mt-4 text-lg">Your expert AI is analyzing the data...</p>
                        </div>
                        <div id="report-content-wrapper" class="hidden report-content p-6"></div>
                     </div>
                 </div>
            </section>
        </div>
    </div>

    <script>
        // --- Chart.js Global Config & Plugins ---
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';
        const chartTextPlugin = {
            id: 'chartTextPlugin',
            beforeDraw(chart) {
                const { width, height, ctx } = chart;
                const text = chart.config.options.plugins.chartTextPlugin.text;
                ctx.restore();
                ctx.font = 'bold 24px Inter';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#e5e7eb';
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2;
                ctx.fillText(text, textX, textY);
                ctx.save();
            }
        };

        // --- Global Chart Instances ---
        let chartInstances = {};

        function copyCommand() {
            const command = document.querySelector('.bg-gray-800 code').innerText;
            navigator.clipboard.writeText(command).then(() => alert('Command copied!'), () => alert('Failed to copy.'));
        }

        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
        }

        function createCharts(data) {
            destroyCharts();

            // CPU Chart
            const cpuUsage = parseFloat(data.performance.cpu_usage_percent) || 0;
            chartInstances.cpu = new Chart(document.getElementById('cpuChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [cpuUsage, 100 - cpuUsage], backgroundColor: ['#ef4444', '#374151'], borderColor: '#1f2937', cutout: '70%' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, chartTextPlugin: { text: `${cpuUsage.toFixed(1)}%` } } },
                plugins: [chartTextPlugin]
            });

            // Memory Chart
            const memUsed = data.memory.total_kb - data.memory.available_kb;
            const memTotal = data.memory.total_kb;
            const memUsagePercent = memTotal > 0 ? (memUsed / memTotal * 100) : 0;
            chartInstances.mem = new Chart(document.getElementById('memChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [memUsagePercent, 100 - memUsagePercent], backgroundColor: ['#f59e0b', '#374151'], borderColor: '#1f2937', cutout: '70%' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, chartTextPlugin: { text: `${memUsagePercent.toFixed(1)}%` } } },
                plugins: [chartTextPlugin]
            });
            
            // Disk Charts
            const diskContainer = document.getElementById('disk-charts-container');
            diskContainer.innerHTML = '';
            data.disk_usage.forEach((disk, index) => {
                const diskUsagePercent = parseInt(disk.use_percent.replace('%', ''));
                const diskHtml = `
                    <div class="w-full">
                        <div class="flex justify-between text-sm mb-1">
                            <span>${disk.mount_point}</span>
                            <span>${diskUsagePercent}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-sky-500 h-2.5 rounded-full" style="width: ${diskUsagePercent}%"></div>
                        </div>
                    </div>
                `;
                diskContainer.innerHTML += diskHtml;
            });
        }

        async function analyzeServer() {
            const snapshotInput = document.getElementById('snapshot-input');
            const encodedData = snapshotInput.value.trim();
            if (!encodedData) {
                alert('Please paste the snapshot output before analyzing.');
                return;
            }

            const analyzeButton = document.getElementById('analyze-button');
            const resultsWrapper = document.getElementById('results-wrapper');
            const loadingIndicator = document.getElementById('loading-indicator');
            const reportContentWrapper = document.getElementById('report-content-wrapper');

            resultsWrapper.classList.remove('hidden');
            loadingIndicator.style.display = 'block';
            reportContentWrapper.classList.add('hidden');
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analyzing...';
            resultsWrapper.scrollIntoView({ behavior: 'smooth' });
            
            try {
                const decodedJson = atob(encodedData);
                const serverData = JSON.parse(decodedJson);
                createCharts(serverData);
            } catch (e) {
                console.error("Failed to decode or parse data for charts:", e);
                const reportOutput = document.getElementById('report-output');
                reportOutput.innerHTML = `<div class="p-6"><p class="text-red-400"><strong>Analysis Failed:</strong> Invalid data format. The provided text is not a valid output from the analyzer script.</p></div>`;
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analyze My Server';
                return;
            }

            const API_ENDPOINT = 'https://stethoscope-ai-backend.onrender.com/api/v1/analyze';

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: encodedData }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                let htmlReport = marked.parse(result.report);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlReport;
                
                tempDiv.querySelectorAll('h3').forEach(h3 => {
                    let card = document.createElement('div');
                    card.className = 'issue-card';
                    if (h3.innerText.includes('🔴')) {
                        card.classList.add('critical');
                    } else if (h3.innerText.includes('🟡')) {
                        card.classList.add('warning');
                    }
                    
                    let contentContainer = document.createElement('div');
                    let sibling = h3.nextElementSibling;
                    while(sibling && sibling.tagName !== 'H3') {
                        contentContainer.appendChild(sibling.cloneNode(true));
                        sibling = sibling.nextElementSibling;
                    }
                    
                    card.appendChild(h3);
                    card.appendChild(contentContainer);
                    
                    let parent = tempDiv.querySelector('h3').parentElement;
                    if(parent) {
                        parent.insertBefore(card, tempDiv.querySelector('h3'));
                        tempDiv.querySelector('h3').remove();
                        while(contentContainer.firstChild) {
                            contentContainer.firstChild.remove();
                        }
                    }
                });
                reportContentWrapper.innerHTML = tempDiv.innerHTML;

            } catch (error) {
                reportContentWrapper.innerHTML = `<p class="text-red-400 p-6"><strong>Analysis Failed:</strong> ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
                reportContentWrapper.classList.remove('hidden');
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analyze My Server';
            }
        }
    </script>

</body>
</html>
