<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stethoscope AI - Instant Server Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .hero-bg {
            background-image: radial-gradient(#1f2937 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .accent-color { color: #38bdf8; }
        .btn-primary {
            background-color: #0ea5e9;
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #0284c7; }
        .code-block {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        /* AI Report Styling */
        .report-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem; border-bottom: 1px solid #374151; padding-bottom: 0.5rem; }
        .report-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; }
        .report-content p { margin-top: 0.75rem; line-height: 1.6; }
        .report-content code { background-color: #374151; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: 'Courier New', Courier, monospace; }
        .report-content pre { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; overflow-x: auto; }
        .report-content .issue-card { background-color: #1f2937; border: 1px solid #374151; border-left-width: 4px; padding: 1.5rem; margin-top: 1.5rem; border-radius: 0.5rem; }
        .report-content .issue-card.critical { border-left-color: #f87171; }
        .report-content .issue-card.warning { border-left-color: #facc15; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <!-- HERO SECTION -->
        <section class="py-20 md:py-32 hero-bg">
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-6xl font-black text-white leading-tight">Instant, AI-Powered Diagnostics <br> for Your <span class="accent-color">Linux Server</span>.</h1>
                <p class="mt-6 text-lg md:text-xl max-w-3xl mx-auto">Go from "Server Down" to "Root Cause Found" in under 60 seconds. Stethoscope AI is your on-demand expert consultant for complex server issues.</p>
                <a href="#analyzer-tool" class="mt-10 inline-block btn-primary font-bold py-4 px-8 rounded-lg text-lg">Start Analysis Now</a>
            </div>
        </section>

        <!-- THE TOOL SECTION -->
        <section id="analyzer-tool" class="py-20">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center text-white">Generate Your Health Report</h2>
                <div class="max-w-4xl mx-auto mt-12">
                    <div class="mb-12">
                        <h3 class="text-xl font-semibold text-white mb-2">Step 1: Copy this command</h3>
                        <div class="code-block rounded-lg p-4 flex items-center justify-between">
                            <pre><code class="text-gray-300">curl -sSL https://your-netlify-site.netlify.app/analyzer.sh | bash</code></pre>
                            <button onclick="copyCommand()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Copy</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-2">Step 2: Paste the output from your terminal below</h3>
                        <textarea id="snapshot-input" rows="8" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-gray-300 focus:ring-2 focus:ring-sky-500 focus:outline-none" placeholder="Paste your encoded snapshot output here..."></textarea>
                        <button onclick="analyzeServer()" id="analyze-button" class="mt-4 w-full btn-primary font-bold py-4 px-8 rounded-lg text-lg">Analyze My Server</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- METRICS & REPORT SECTION (Initially Hidden) -->
        <div id="results-wrapper" class="hidden">
            <!-- INSTANT METRICS SECTION -->
            <section id="metrics-section" class="py-20 bg-gray-900">
                 <div class="container mx-auto px-6 max-w-6xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-12">Instant Metrics Snapshot</h2>
                    <div class="grid md:grid-cols-2 gap-8 items-start">
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-white text-center mb-4">CPU & Memory Utilization</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <canvas id="cpuChart"></canvas>
                                <canvas id="memChart"></canvas>
                            </div>
                        </div>
                        <div id="disk-charts-container" class="bg-gray-800 p-6 rounded-lg">
                             <h3 class="text-xl font-bold text-white text-center mb-4">Disk Usage</h3>
                             <!-- Disk charts will be injected here -->
                        </div>
                    </div>
                 </div>
            </section>

            <!-- AI REPORT SECTION -->
            <section id="report-section" class="py-20">
                 <div class="container mx-auto px-6 max-w-4xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-8">Your AI-Generated Analysis</h2>
                    <div id="report-output" class="p-6 rounded-lg bg-gray-800 border border-gray-700">
                        <div id="loading-indicator" class="text-center">
                            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p class="mt-4 text-lg">Your expert AI is analyzing the data... This may take a moment.</p>
                        </div>
                        <div id="report-content-wrapper" class="hidden report-content"></div>
                     </div>
                 </div>
            </section>
        </div>
    </div>

    <script>
        // --- Chart.js Global Config ---
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        // --- Global Chart Instances ---
        let cpuChartInstance, memChartInstance;
        const diskChartInstances = [];

        function copyCommand() {
            const command = document.querySelector('.code-block code').innerText;
            navigator.clipboard.writeText(command).then(() => alert('Command copied!'), () => alert('Failed to copy.'));
        }

        function destroyCharts() {
            if (cpuChartInstance) cpuChartInstance.destroy();
            if (memChartInstance) memChartInstance.destroy();
            diskChartInstances.forEach(chart => chart.destroy());
            diskChartInstances.length = 0;
        }

        function createCharts(data) {
            destroyCharts(); // Clear previous charts

            // CPU Chart
            const cpuData = data.top_processes.find(p => p.type === 'cpu');
            const cpuUsage = cpuData ? parseFloat(cpuData.cpu_percent) : 0;
            cpuChartInstance = new Chart(document.getElementById('cpuChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Idle'],
                    datasets: [{
                        data: [cpuUsage, 100 - cpuUsage],
                        backgroundColor: ['#ef4444', '#374151'],
                        borderColor: '#1f2937',
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'CPU Usage (%)' } } }
            });

            // Memory Chart
            const memUsed = data.memory.total_kb - data.memory.available_kb;
            const memTotal = data.memory.total_kb;
            const memUsagePercent = memTotal > 0 ? (memUsed / memTotal * 100).toFixed(2) : 0;
            memChartInstance = new Chart(document.getElementById('memChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Available'],
                    datasets: [{
                        data: [memUsed, data.memory.available_kb],
                        backgroundColor: ['#f59e0b', '#374151'],
                        borderColor: '#1f2937',
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Memory Usage' } } }
            });
            
            // Disk Charts
            const diskContainer = document.getElementById('disk-charts-container');
            // Clear previous disk charts
            diskContainer.querySelectorAll('canvas').forEach(c => c.remove());
            data.disk_usage.forEach((disk, index) => {
                const canvas = document.createElement('canvas');
                canvas.id = `diskChart${index}`;
                diskContainer.appendChild(canvas);
                
                const diskUsagePercent = parseInt(disk.use_percent.replace('%', ''));
                const diskChart = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: [disk.mount_point],
                        datasets: [{
                            label: 'Used %',
                            data: [diskUsagePercent],
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });
                diskChartInstances.push(diskChart);
            });
        }

        async function analyzeServer() {
            const snapshotInput = document.getElementById('snapshot-input');
            const analyzeButton = document.getElementById('analyze-button');
            const resultsWrapper = document.getElementById('results-wrapper');
            const loadingIndicator = document.getElementById('loading-indicator');
            const reportContentWrapper = document.getElementById('report-content-wrapper');

            const encodedData = snapshotInput.value.trim();
            if (!encodedData) {
                alert('Please paste the snapshot output before analyzing.');
                return;
            }

            resultsWrapper.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            reportContentWrapper.classList.add('hidden');
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analyzing...';
            resultsWrapper.scrollIntoView({ behavior: 'smooth' });
            
            // --- NEW: Decode data locally for instant charts ---
            try {
                const decodedJson = atob(encodedData);
                const serverData = JSON.parse(decodedJson);
                createCharts(serverData);
            } catch (e) {
                console.error("Failed to decode or parse data for charts:", e);
                // Don't stop, still try to get AI report
            }

            // --- API Call to Backend ---
            const API_ENDPOINT = 'https://stethoscope-ai-backend.onrender.com/api/v1/analyze'; // Use your Render URL

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: encodedData }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Parse the markdown and add classes to issue sections
                let htmlReport = marked.parse(result.report);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlReport;
                
                tempDiv.querySelectorAll('h3').forEach(h3 => {
                    if (h3.innerText.includes('🔴')) {
                        let parent = h3.parentElement;
                        if(parent.tagName !== 'BODY') {
                           let card = document.createElement('div');
                           card.className = 'issue-card critical';
                           card.appendChild(h3.cloneNode(true));
                           let sibling = h3.nextElementSibling;
                           while(sibling && sibling.tagName !== 'H3') {
                               card.appendChild(sibling.cloneNode(true));
                               sibling = sibling.nextElementSibling;
                           }
                           h3.replaceWith(card);
                        }
                    } else if (h3.innerText.includes('🟡')) {
                       let card = document.createElement('div');
                       card.className = 'issue-card warning';
                       card.appendChild(h3.cloneNode(true));
                       let sibling = h3.nextElementSibling;
                       while(sibling && sibling.tagName !== 'H3') {
                           card.appendChild(sibling.cloneNode(true));
                           sibling = sibling.nextElementSibling;
                       }
                       h3.replaceWith(card);
                    }
                });

                // This is a simplified way to handle the replacement. A more robust solution would be needed for complex structures.
                // For now, we'll just re-render the whole thing.
                reportContentWrapper.innerHTML = tempDiv.innerHTML;


            } catch (error) {
                reportContentWrapper.innerHTML = `<p class="text-red-400"><strong>Analysis Failed:</strong> ${error.message}</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                reportContentWrapper.classList.remove('hidden');
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analyze My Server';
            }
        }
    </script>

</body>
</html>
